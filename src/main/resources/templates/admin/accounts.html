<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <title>Admin • Accounts</title>

    <!-- CSS header cần -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link th:href="@{/css/home.css}" rel="stylesheet">
    <link th:href="@{/css/admin-accounts.css}" rel="stylesheet">
</head>
<body>

<!-- Header dùng chung -->
<div th:replace="~{common/header :: header}"></div>

<main class="admin-content">
    <div class="wrap" th:with="fixedEmail=${fixedAdminEmail != null ? fixedAdminEmail : 'admin@gmail.com'}">

        <div class="page-head">
            <div>
                <h1 class="title">Accounts</h1>
                <p class="subtitle">Quản lý tài khoản</p>
            </div>
        </div>

        <div class="tabs">
            <a class="tab" th:classappend="${page}=='home' ? 'active'" th:href="@{/admin/adminhome}">Home</a>
            <a class="tab" th:classappend="${page}=='accounts' ? 'active'" th:href="@{/admin/accounts}">Accounts</a>
        </div>

        <p th:if="${msg != null and !#strings.isEmpty(#strings.trim(msg))}"
           class="flash" th:text="${msg}" id="flash"></p>

        <!-- Empty -->
        <div th:if="${accPage == null or accPage.totalElements == 0}" class="empty">No accounts.</div>

        <!-- List -->
        <div th:if="${accPage != null and accPage.totalElements > 0}" class="card">
            <div class="card-head">
                <h3 class="card-title">Account List</h3>

                <!-- Filters: GET /admin/accounts  (KHÔNG lồng form khác ở trong) -->
                <form class="filters" th:action="@{/admin/accounts}" method="get">
                    <input type="text" name="q" placeholder="Search email or name…" th:value="${q}">

                    <select name="sort" th:value="${sort}">
                        <option value="accountId,asc">ID ↑</option>
                        <option value="accountId,desc">ID ↓</option>
                        <option value="email,asc">Email A–Z</option>
                        <option value="email,desc">Email Z–A</option>
                        <option value="fullName,asc">Name A–Z</option>
                        <option value="fullName,desc">Name Z–A</option>
                        <option value="createdAt,desc">Newest</option>
                        <option value="createdAt,asc">Oldest</option>
                    </select>

                    <select name="size" th:value="${accPage.size}">
                        <option value="5">5 / page</option>
                        <option value="10">10 / page</option>
                        <option value="20">20 / page</option>
                        <option value="50">50 / page</option>
                    </select>

                    <!-- lọc trạng thái -->
                    <select name="status" th:value="${status}">
                        <option value="">All</option>
                        <option value="ACTIVE" th:selected="${status}=='ACTIVE'">Active</option>
                        <option value="DEACTIVATED" th:selected="${status}=='DEACTIVATED'">Deactivated</option>
                    </select>


                    <button class="btn update" type="submit">Apply</button>
                    <a class="btn" th:href="@{/admin/accounts}">Reset</a>
                </form>
            </div>

            <div class="table-wrap">
                <table>
                    <thead>
                    <tr>
                        <th style="width:90px">ID</th>
                        <th>Email</th>
                        <th>Full name</th>
                        <th style="width:120px">Status</th>
                        <th style="width:120px">Role</th>
                        <th style="width:260px">Change role</th>
                        <th style="width:260px">Actions</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="a : ${accPage.content}"
                        th:with="isActive=${a.status != null and a.status.name() == 'ACTIVE'},
                       isFixed=${#strings.equalsIgnoreCase(a.email, fixedEmail)}">

                        <td class="small" th:text="${a.accountId}">1</td>
                        <td th:text="${a.email}">email@example.com</td>
                        <td th:text="${a.fullName}">Name</td>

                        <!-- Status badge -->
                        <td>
                            <span th:if="${isActive}" class="badge status-active">ACTIVE</span>
                            <span th:if="${!isActive}" class="badge status-deactivated">DEACTIVATED</span>
                        </td>

                        <td>
                            <span th:if="${a.role != null}" class="badge role" th:text="${a.role.roleName}">ROLE</span>
                            <span th:if="${a.role == null}" class="badge">N/A</span>
                        </td>

                        <!-- Change role -->
                        <td>
                            <form class="inline" th:action="@{|/admin/accounts/${a.accountId}/role|}" method="post">
                                <div th:if="${_csrf != null}">
                                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                                </div>

                                <select name="role" required th:disabled="${isFixed}">
                                    <option th:each="r : ${roles}"
                                            th:value="${r}"
                                            th:text="${r}"
                                            th:selected="${a.role != null and a.role.roleName == r}">
                                    </option>
                                </select>

                                <button class="btn update" type="submit" th:disabled="${isFixed}">Update</button>
                                <div class="note" th:if="${isFixed}"></div>
                            </form>
                        </td>

                        <!-- Actions -->
                        <td class="actions">
                            <a class="btn view" th:href="@{|/admin/accounts/${a.accountId}|}">View</a>

                            <!-- Deactivate nếu ACTIVE -->
                            <form class="inline" th:if="${isActive}"
                                  th:action="@{|/admin/accounts/${a.accountId}/delete|}"
                                  method="post"
                                  onsubmit="return confirm('Deactivate this account?');">
                                <div th:if="${_csrf != null}">
                                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                                </div>
                                <button class="btn delete" type="submit" th:disabled="${isFixed}">Deactivate</button>
                            </form>

                            <!-- Reactivate nếu DEACTIVATED -->
                            <form class="inline" th:if="${!isActive}"
                                  th:action="@{|/admin/accounts/${a.accountId}/reactivate|}"
                                  method="post"
                                  onsubmit="return confirm('Reactivate this account?');">
                                <div th:if="${_csrf != null}">
                                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                                </div>
                                <button class="btn update" type="submit" th:disabled="${isFixed}">Reactivate</button>
                            </form>
                        </td>

                    </tr>
                    </tbody>
                </table>
            </div>

            <!-- Pagination footer -->
            <div class="pager">
                <div class="subtitle">Showing page [[${accPage.number + 1}]] of [[${accPage.totalPages}]]</div>

                <ul class="pagination">
                    <!-- Prev -->
                    <li th:classappend="${accPage.first} ? 'disabled'">
                        <a th:if="${!accPage.first}"
                           th:href="@{/admin/accounts(q=${q}, status=${status}, page=${accPage.number - 1}, size=${accPage.size}, sort=${sort})}">&laquo; Prev</a>
                        <span th:if="${accPage.first}">&laquo; Prev</span>
                    </li>

                    <!-- Info -->
                    <li class="pageinfo">
                        <span>Page [[${accPage.number + 1}]] / [[${accPage.totalPages}]] • Total [[${accPage.totalElements}]]</span>
                    </li>

                    <!-- Next -->
                    <li th:classappend="${accPage.last} ? 'disabled'">
                        <a th:if="${!accPage.last}"
                           th:href="@{/admin/accounts(q=${q}, status=${status}, page=${accPage.number + 1}, size=${accPage.size}, sort=${sort})}">Next &raquo;</a>
                        <span th:if="${accPage.last}">Next &raquo;</span>
                    </li>
                </ul>
            </div>
        </div>

    </div>
</main>

<!-- Bootstrap JS để dropdown trong header hoạt động -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" defer></script>
</body>
</html>
