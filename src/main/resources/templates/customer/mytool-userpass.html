<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>T√†i kho·∫£n d·ªãch v·ª•</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link th:href="@{/css/mytool.css}" rel="stylesheet">
</head>
<body>

<!-- MAIN -->
<div class="container mt-4" th:object="${acc}">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h4 class="mb-0">üß∞ Tool: <span th:text="${tool.toolName}">Tool</span></h4>
            <small class="text-muted">
                Ph∆∞∆°ng th·ª©c: <span th:text="*{loginMethod}">USER_PASSWORD</span> ¬∑
                M√£ ƒë∆°n: <span th:text="${order.orderId}">0</span>
            </small>
        </div>

        <div class="d-flex gap-2">
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#editModal">Edit</button>
            <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#renewModal">Renew</button>
            <a class="btn btn-outline-secondary" th:href="@{|/my-tools/${order.orderId}/history|}">History</a>
        </div>
    </div>

    <div th:if="${ok}" class="alert alert-success" th:text="${ok}"></div>
    <div th:if="${err}" class="alert alert-danger" th:text="${err}"></div>

    <!-- TH√îNG TIN T√ÄI KHO·∫¢N -->
    <div class="table-responsive">
        <table class="table table-bordered align-middle">
            <tbody>
            <tr><th style="width:260px">License Account ID</th><td th:text="*{licenseAccountId}">-</td></tr>
            <tr><th>Login method</th><td th:text="*{loginMethod}">USER_PASSWORD</td></tr>

            <tr>
                <th>Username</th>
                <td class="d-flex align-items-center gap-2">
                    <span id="uVal" th:text="*{username}">user</span>
                    <button class="btn btn-sm btn-outline-secondary" type="button" onclick="copyText('uVal')">Copy</button>
                </td>
            </tr>

            <tr>
                <th>Password</th>
                <td class="d-flex align-items-center gap-2">
                    <code id="pVal" th:text="*{password}">******</code>
                    <button class="btn btn-sm btn-outline-secondary" type="button" onclick="togglePwd()">Hi·ªán/·∫®n</button>
                    <button class="btn btn-sm btn-outline-primary" type="button" onclick="copyText('pVal')">Copy</button>
                </td>
            </tr>

            <tr>
                <th>Status</th>
                <td th:switch="${acc.status != null ? acc.status.name() : null}">
                    <span class="badge text-bg-success"  th:case="'ACTIVE'">ACTIVE</span>
                    <span class="badge text-bg-secondary" th:case="'EXPIRED'">EXPIRED</span>
                    <span class="badge text-bg-danger"   th:case="'REVOKED'">REVOKED</span>
                    <span class="badge text-bg-secondary" th:case="*">N/A</span>
                </td>
            </tr>

            <tr>
                <th>Hi·ªáu l·ª±c</th>
                <td>
                    <span th:text="${acc.startDate != null ? #temporals.format(acc.startDate,'dd/MM/yyyy HH:mm') : '-'}">-</span>
                    ‚Üí
                    <span th:text="${acc.endDate != null ? #temporals.format(acc.endDate,'dd/MM/yyyy HH:mm') : '-'}">-</span>
                </td>
            </tr>

            <tr>
                <th>ƒê√£ k√≠ch ho·∫°t</th>
                <td>
                    <span th:text="*{used} ? 'Yes' : 'No'">No</span>
                    <span th:if="*{activatedAt != null}">
                        ¬∑ <span th:text="${#temporals.format(acc.activatedAt,'dd/MM/yyyy HH:mm')}">-</span>
                    </span>
                </td>
            </tr>

            <tr><th>License g√≥i (l·∫ßn mua g·∫ßn nh·∫•t)</th><td th:text="${order.license != null ? order.license.name : '-'}">-</td></tr>

            <!-- ‚úÖ T·ªáp c√†i ƒë·∫∑t / file ƒë√≠nh k√®m (ch·ªâ cho t·∫£i WRAPPED) -->
            <tr>
                <th>T·ªáp c√†i ƒë·∫∑t / file ƒë√≠nh k√®m</th>
                <td>
                    <div th:if="${#lists.isEmpty(files)}" class="text-muted">Ch∆∞a c√≥ file</div>
                    <div class="d-flex flex-wrap gap-2" th:if="${!#lists.isEmpty(files)}">
                        <a class="btn btn-sm btn-outline-primary"
                           th:each="f : ${files}"
                           th:if="${f.fileType != null and f.fileType.name() == 'WRAPPED'}"
                           th:href="@{|/my-tools/${order.orderId}/files/${f.fileId}|}">
                            Download
                        </a>
                        <!-- Kh√¥ng render n√∫t cho ORIGINAL -->
                    </div>
                </td>
            </tr>
            </tbody>
        </table>
    </div>

    <a href="/orders" class="btn btn-link mt-3">¬´ Quay l·∫°i ƒë∆°n h√†ng</a>
</div>
<!-- /MAIN -->

<!-- MODAL: EDIT (USER_PASSWORD) -->
<div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <form id="editForm" class="modal-content needs-validation" method="post"
              th:action="@{|/my-tools/${order.orderId}/account|}" novalidate>
            <div class="modal-header">
                <h5 class="modal-title">Ch·ªânh s·ª≠a t√†i kho·∫£n</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body" th:object="${acc}">
                <div class="mb-3">
                    <label class="form-label">Username</label>
                    <input class="form-control"
                           name="username"
                           th:value="*{username}"
                           required minlength="3" maxlength="100"
                           pattern="^[A-Za-z0-9._-]{3,100}$"
                           oninput="this.value=this.value.replace(/\s/g,'')"
                           placeholder="V√≠ d·ª•: user.name_01">
                    <div class="invalid-feedback">
                        Username kh√¥ng h·ª£p l·ªá. ƒê·ªãnh d·∫°ng ƒë√∫ng: 3‚Äì100 k√Ω t·ª±, ch·ªâ d√πng ch·ªØ, s·ªë, d·∫•u <code>.</code>, <code>_</code>, <code>-</code>, kh√¥ng c√≥ kho·∫£ng tr·∫Øng.
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label">Password</label>
                    <div class="input-group has-validation">
                        <input class="form-control"
                               type="password"
                               id="pwdInput"
                               name="password"
                               th:value="*{password}"
                               required minlength="8" maxlength="100"
                               pattern="^(?=.*[a-z])(?=.*[A-Z])(?=.*[0-9])\S{8,100}$"
                               oninput="this.value=this.value.replace(/\s/g,'')"
                               placeholder="T·ªëi thi·ªÉu 8 k√Ω t·ª±, g·ªìm hoa, th∆∞·ªùng, s·ªë; kh√¥ng kho·∫£ng tr·∫Øng">
                        <button class="btn btn-outline-secondary" type="button" onclick="togglePwdEdit()">Hi·ªán/·∫®n</button>
                        <div class="invalid-feedback">
                            M·∫≠t kh·∫©u ph·∫£i ‚â• 8 k√Ω t·ª±, c√≥ √≠t nh·∫•t 1 ch·ªØ th∆∞·ªùng, 1 CH·ªÆ HOA, 1 ch·ªØ s·ªë; kh√¥ng c√≥ kho·∫£ng tr·∫Øng.
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">H·ªßy</button>
                <button class="btn btn-primary" type="submit">L∆∞u</button>
            </div>
        </form>
    </div>
</div>

<!-- MODAL: RENEW -->
<div class="modal fade" id="renewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <!-- ƒë·ªïi action: /renew-payment/vnpay -->
        <form class="modal-content" method="post" th:action="@{/renew-payment/vnpay}">
            <div class="modal-header">
                <h5 class="modal-title">Ch·ªçn g√≥i gia h·∫°n</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body">
                <!-- truy·ªÅn orderId ·∫©n -->
                <input type="hidden" name="orderId" th:value="${order.orderId}"/>

                <div th:if="${#lists.isEmpty(licenses)}" class="alert alert-warning mb-0">
                    Ch∆∞a c√≥ g√≥i license n√†o ƒë∆∞·ª£c c·∫•u h√¨nh cho Tool n√†y.
                </div>

                <div class="list-group" th:if="${!#lists.isEmpty(licenses)}">
                    <label class="list-group-item d-flex align-items-center" th:each="l : ${licenses}">
                        <input class="form-check-input me-2" type="radio" name="licenseId" th:value="${l.licenseId}" required>
                        <div class="flex-grow-1">
                            <div class="fw-semibold" th:text="${l.name}">G√≥i</div>
                            <small class="text-muted">
                                <span th:text="${l.durationDays}">30</span> ng√†y ¬∑
                                <span th:text="${#numbers.formatDecimal(l.price,0,'COMMA',0,'POINT')}">0</span> VND
                            </small>
                        </div>
                    </label>
                </div>

                <!-- CSRF (n·∫øu b·∫≠t Spring Security) -->
                <input type="hidden" th:if="${_csrf != null}"
                       th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

                <div class="form-text mt-2">
                    Sau khi x√°c nh·∫≠n, h·ªá th·ªëng s·∫Ω t·∫°o giao d·ªãch VNPay v√† c·∫≠p nh·∫≠t h·∫°n s·ª≠ d·ª•ng khi thanh to√°n th√†nh c√¥ng.
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">ƒê√≥ng</button>
                <button class="btn btn-success" type="submit" th:disabled="${#lists.isEmpty(licenses)}">Thanh to√°n VNPay</button>
            </div>
        </form>
    </div>
</div>


<!-- SCRIPTS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function(){
        const el = document.getElementById('pVal');
        if (el && !el.dataset.orig) el.dataset.orig = el.textContent;
        if (el) el.dataset.real = '1';
    });

    function togglePwd(){
        const el = document.getElementById('pVal');
        if (!el) return;
        if (el.dataset.real === '1') { el.textContent = '******'; el.dataset.real = '0'; }
        else { el.textContent = el.dataset.orig || ''; el.dataset.real = '1'; }
    }
    function togglePwdEdit(){
        const i = document.getElementById('pwdInput');
        i.type = (i.type === 'password') ? 'text' : 'password';
    }
    function copyText(id){
        const t = document.getElementById(id)?.innerText || '';
        navigator.clipboard.writeText(t).then(()=>alert('ƒê√£ copy'));
    }

    // Bootstrap 5 validation
    (function () {
        'use strict';
        const form = document.getElementById('editForm');
        if (!form) return;

        form.querySelectorAll('input[required]').forEach(inp => {
            const refresh = () => {
                if (!inp.value) { inp.classList.remove('is-invalid','is-valid'); return; }
                if (inp.checkValidity()) { inp.classList.remove('is-invalid'); inp.classList.add('is-valid'); }
                else { inp.classList.add('is-invalid'); inp.classList.remove('is-valid'); }
            };
            inp.addEventListener('blur', refresh);
            inp.addEventListener('input', refresh);
        });

        form.addEventListener('submit', function (e) {
            if (!form.checkValidity()) {
                e.preventDefault(); e.stopPropagation();
                form.querySelectorAll('input').forEach(i => { if (!i.checkValidity()) i.classList.add('is-invalid'); });
            }
        }, false);
    })();
</script>
</body>
</html>
