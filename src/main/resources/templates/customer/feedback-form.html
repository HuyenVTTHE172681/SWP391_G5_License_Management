<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Gửi đánh giá</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .star { font-size: 28px; cursor: pointer; color: #ccc; }
        .star.active, .star.hover { color: #f5c518; }
    </style>
</head>
<body>
<div class="container my-4">
    <a th:href="@{/orders}" class="btn btn-link mb-2">« Quay lại đơn hàng</a>

    <div class="card">
        <div class="card-body">
            <h5 class="card-title mb-1" th:text="${tool.toolName}">Tool name</h5>
            <div class="text-muted mb-3">Mã đơn: <span th:text="${order.orderId}">0</span></div>

            <form method="post" th:action="@{|/orders/${order.orderId}/feedback|}">
                <div class="mb-3">
                    <label class="form-label d-block">Đánh Giá</label>
                    <input type="hidden" id="rating" name="rating" value="5">
                    <span class="star" data-v="1">★</span>
                    <span class="star" data-v="2">★</span>
                    <span class="star" data-v="3">★</span>
                    <span class="star" data-v="4">★</span>
                    <span class="star" data-v="5">★</span>
                </div>

                <div class="mb-3">
                    <label class="form-label">Nhận xét (tối đa 100 ký tự)</label>
                    <textarea id="comment" class="form-control"
                              name="comment" rows="3" maxlength="100" spellcheck="false"
                              placeholder="Viết ngắn gọn trải nghiệm của bạn..."></textarea>
                    <div class="d-flex justify-content-between">
                        <div class="invalid-feedback">Vui lòng không chèn khoảng trắng giữa từng ký tự.</div>
                        <small class="text-muted"><span id="cc">0</span>/100</small>
                    </div>
                </div>

                <div class="d-flex gap-2">
                    <button class="btn btn-primary" type="submit">Gửi đánh giá</button>
                    <a th:href="@{/orders}" class="btn btn-outline-secondary">Hủy</a>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    // Sao mặc định = 5
    const stars = document.querySelectorAll('.star');
    const ratingInput = document.getElementById('rating');
    function render(val){ stars.forEach(s => s.classList.toggle('active', +s.dataset.v <= val)); }
    render(+ratingInput.value);
    stars.forEach(s=>{
        s.addEventListener('mouseover', ()=>render(+s.dataset.v));
        s.addEventListener('mouseout',  ()=>render(+ratingInput.value));
        s.addEventListener('click',     ()=>{ ratingInput.value = s.dataset.v; render(+ratingInput.value); });
    });

    (function () {
        const ta = document.getElementById('comment');
        const cc = document.getElementById('cc');
        if (!ta) return;

        // Gộp mọi khoảng trắng liên tiếp thành 1 (kể cả dán)
        function collapseSpaces(s) {
            return s.replace(/\u00A0/g, ' ')      // non-breaking space -> space
                .replace(/\s{2,}/g, ' ')      // 2+ spaces -> 1
                .replace(/[\t\f\v\r]+/g, ' ') // tab -> space
                .trimStart();                 // tránh space đầu
        }

        // Phát hiện kiểu “c h ữ  c á c h 1 space”
        function looksSpacedOutText(s){
            s = (s || '').trim().replace(/\s+/g,' ');
            if (s.length < 9) return false;            // tối thiểu như "a a a a a"
            const parts = s.split(' ');
            if (parts.length < 5) return false;
            return parts.every(p => /^[\p{L}\p{N}]$/u.test(p));
        }

        // Cập nhật bộ đếm + gộp space khi nhập
        const onInput = () => {
            const collapsed = collapseSpaces(ta.value);
            if (collapsed !== ta.value) ta.value = collapsed;
            cc.textContent = ta.value.length;
            ta.classList.remove('is-invalid');
        };
        ta.addEventListener('input', onInput);
        ta.addEventListener('paste', e => {
            e.preventDefault();
            const text = (e.clipboardData || window.clipboardData).getData('text');
            const start = ta.selectionStart, end = ta.selectionEnd;
            const before = ta.value.slice(0, start);
            const after  = ta.value.slice(end);
            ta.value = before + collapseSpaces(text) + after;
            ta.selectionStart = ta.selectionEnd = (before + collapseSpaces(text)).length;
            onInput();
        });
        onInput();

        // Validate trước khi submit
        ta.form?.addEventListener('submit', (e) => {
            ta.value = collapseSpaces(ta.value).trim(); // chuẩn hoá lần cuối
            cc.textContent = ta.value.length;

            // Cho phép rỗng, nhưng nếu có nội dung thì cấm kiểu “c h ữ”
            if (ta.value && looksSpacedOutText(ta.value)) {
                e.preventDefault();
                ta.classList.add('is-invalid');
                ta.focus();
            }
        });
    })();
</script>
</body>
</html>
