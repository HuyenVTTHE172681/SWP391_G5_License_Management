<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ƒê∆°n h√†ng c·ªßa t√¥i</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link th:href="@{/css/home.css}" rel="stylesheet">
    <style>
        /* CƒÉn t·∫•t c·∫£ n√∫t h√†nh ƒë·ªông tr√™n c√πng 1 d√≤ng */
        td.text-center > .btn {
            display: inline-flex;      /* cho ph√©p icon v√† text n·∫±m g·ªçn g√†ng */
            align-items: center;       /* cƒÉn gi·ªØa icon v√† text theo chi·ªÅu d·ªçc */
            margin: 0 2px;             /* kho·∫£ng c√°ch gi·ªØa c√°c n√∫t */
            white-space: nowrap;       /* kh√¥ng cho xu·ªëng d√≤ng */
        }

        /* T√πy ch·ªçn: l√†m h√†ng n√∫t g·ªçn h∆°n trong c·ªôt */
        td.text-center {
            white-space: nowrap;       /* to√†n b·ªô √¥ kh√¥ng b·ªã wrap */
        }

        /* N·∫øu icon ‚Üí ch·ªØ, cho kho·∫£ng c√°ch nh·ªè gi·ªØa icon v√† ch·ªØ */
        .btn i {
            margin-right: 2px;
        }
    </style>

</head>
<body>
<!--Header-->
<div th:replace="common/header :: header"></div>

<!--Body-->
<div class="container mt-5">
    <h3 class="text-center mb-4">üõí ƒê∆°n h√†ng ƒë√£ mua</h3>

    <!-- FORM L·ªåC & T√åM KI·∫æM -->
    <!-- hx-get: g·ªçi endpoint /orders/filter khi form submit -->
    <!-- hx-target: ph·∫ßn t·ª≠ s·∫Ω ƒë∆∞·ª£c thay th·∫ø n·ªôi dung -->
    <!-- hx-swap="innerHTML": ch·ªâ thay n·ªôi dung b√™n trong -->
    <form hx-get="/orders/filter"
          hx-target="#orderTableContainer"
          hx-trigger="submit"
          hx-swap="innerHTML"
          class="row g-2 mb-3">

        <!-- H√†ng 1: SEARCH - TR·∫†NG TH√ÅI - TH·ªúI GIAN - GI√Å -->
        <div class="row g-2 align-items-center mb-2">
            <div class="col-md-3">
                <input type="text" name="keyword" th:value="${keyword}" class="form-control"
                       placeholder="T√¨m theo m√£, tool, ng∆∞·ªùi b√°n, license...">
            </div>

            <div class="col-md-3">
                <select name="status" class="form-select">
                    <option value="">T·∫•t c·∫£ tr·∫°ng th√°i</option>
                    <option value="SUCCESS" th:selected="${status == 'SUCCESS'}">Th√†nh c√¥ng</option>
<!--                    <option value="PENDING" th:selected="${status == 'PENDING'}">ƒêang x·ª≠ l√Ω</option>-->
                    <option value="FAILED" th:selected="${status == 'FAILED'}">Th·∫•t b·∫°i</option>
                </select>
            </div>

            <div class="col-md-3">
                <select name="dateRange" class="form-select">
                    <option value="">M·ªçi th·ªùi gian</option>
                    <option value="7" th:selected="${dateRange == '7'}">7 ng√†y g·∫ßn ƒë√¢y</option>
                    <option value="30" th:selected="${dateRange == '30'}">1 th√°ng g·∫ßn ƒë√¢y</option>
                    <option value="90" th:selected="${dateRange == '90'}">3 th√°ng g·∫ßn ƒë√¢y</option>
                </select>
            </div>

            <div class="col-md-3">
                <select name="priceRange" class="form-select">
                    <option value="">M·ªçi gi√°</option>
                    <option value="0-100000" th:selected="${priceRange == '0-100000'}">D∆∞·ªõi 100.000</option>
                    <option value="100000-500000" th:selected="${priceRange == '100000-500000'}">100.000 - 500.000</option>
                    <option value="500000-1000000" th:selected="${priceRange == '500000-1000000'}">500.000 - 1.000.000</option>
                    <option value="1000000+" th:selected="${priceRange == '1000000+'}">Tr√™n 1.000.000</option>
                </select>
            </div>
        </div>

        <!-- H√†ng 2: SORT + DIRECTION + BUTTONS -->
        <div class="row g-2 justify-content-left align-items-center">
            <div class="col-md-2">
                <select name="sortField" class="form-select pe-5">
                    <option value="createdAt" th:selected="${sortField == 'createdAt'}">Ng√†y mua</option>
                    <option value="price" th:selected="${sortField == 'price'}">ƒê∆°n gi√°</option>
                    <option value="orderId" th:selected="${sortField == 'orderId'}">M√£ ƒë∆°n h√†ng</option>
                </select>
            </div>

            <div class="col-md-2">
                <select name="sortDir" class="form-select text-left">
                    <option value="desc" th:selected="${sortDir == 'desc'}">Gi·∫£m d·∫ßn</option>
                    <option value="asc" th:selected="${sortDir == 'asc'}">TƒÉng d·∫ßn</option>
                </select>
            </div>

            <div class="col-md-auto">
                <button type="submit" class="btn btn-primary px-4">
                    <i class="bi bi-search"></i> T√¨m ki·∫øm
                </button>
            </div>

            <div class="col-md-auto">
                <a href="/orders" class="btn btn-secondary px-4">
                    <i class="bi bi-x-circle"></i> X√≥a l·ªçc
                </a>
            </div>
        </div>
    </form>

    <!-- DANH S√ÅCH ƒê∆†N H√ÄNG -->
    <!-- id="orderTableContainer" l√† n∆°i HTMX s·∫Ω render l·∫°i n·ªôi dung -->
    <!-- th:fragment gi√∫p server tr·∫£ v·ªÅ ri√™ng ph·∫ßn n√†y n·∫øu ch·ªâ c·∫ßn update -->
    <div id="orderTableContainer" th:fragment="orderTableFragment">

        <!-- N·∫øu kh√¥ng c√≥ d·ªØ li·ªáu -->
        <div th:if="${ordersPage.empty}" class="alert alert-warning text-center">
            Kh√¥ng c√≥ ƒë∆°n h√†ng n√†o ph√π h·ª£p v·ªõi b·ªô l·ªçc.
        </div>

        <!-- N·∫øu c√≥ d·ªØ li·ªáu, hi·ªÉn th·ªã b·∫£ng -->
        <table th:if="${!ordersPage.empty}" class="table table-bordered table-hover align-middle">
            <thead class="table-primary text-center">
            <tr>
                <th>M√£ ƒë∆°n h√†ng</th>
                <th>Ng√†y mua</th>
                <th>Ng∆∞·ªùi b√°n</th>
                <th>M·∫∑t h√†ng</th>
                <th>G√≥i</th>
                <th>ƒê∆°n gi√°</th>
                <th>Tr·∫°ng th√°i</th>
                <th>H√†nh ƒë·ªông</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="order : ${ordersPage.content}">
                <td th:text="${order.orderId}"></td>
                <td th:text="${#temporals.format(order.createdAt, 'dd/MM/yyyy HH:mm')}"></td>
                <td th:text="${order.tool.seller.fullName}"></td>
                <td th:text="${order.tool.toolName}"></td>
                <td th:text="${order.license.name}"></td>
                <td th:text="${#numbers.formatDecimal(order.price, 0, 'COMMA', 0, 'POINT')} + ' VND'"></td>
                <td class="text-center">
                <span th:switch="${order.orderStatus.name()}">
                    <span th:case="'SUCCESS'" class="badge bg-success">Th√†nh c√¥ng</span>
                    <span th:case="'FAILED'" class="badge bg-danger">Th·∫•t b·∫°i</span>
                    <span th:case="*">Kh√¥ng x√°c ƒë·ªãnh</span>
                </span>
                </td>
                <td class="text-center">
                    <button class="btn btn-sm btn-primary" title="Xem chi ti·∫øt">
                        <i class="bi bi-eye"></i>
                    </button>
                    <button class="btn btn-sm btn-warning" th:disabled="${!order.canFeedbackOrReport}">Feedback</button>
                    <button class="btn btn-sm btn-danger" th:disabled="${!order.canFeedbackOrReport}">Report</button>
                    <a th:href="@{'/my-tools/' + ${order.orderId}}"
                       class="btn btn-sm btn-success"
                       th:disabled="${!order.canFeedbackOrReport}">
                        <i class="bi bi-arrow-right"></i> D√πng d·ªãch v·ª•
                    </a>

                </td>
            </tr>
            </tbody>
        </table>

        <!-- Ph√¢n trang -->
        <nav th:if="${totalPages >= 1}">
            <ul class="pagination justify-content-center align-items-center">

                <!-- Trang tr∆∞·ªõc -->
                <li class="page-item" th:classappend="${currentPage == 0} ? 'disabled'">
                    <a class="page-link"
                       th:attr="hx-get=@{'/orders/filter'(page=${currentPage - 1}, keyword=${keyword}, status=${status},
                                                dateRange=${dateRange}, priceRange=${priceRange},
                                                sortField=${sortField}, sortDir=${sortDir}, size=${size})}"
                       hx-target="#orderTableContainer"
                       hx-swap="innerHTML">
                        Tr∆∞·ªõc
                    </a>
                </li>

                <!-- C√°c s·ªë trang -->
                <li class="page-item"
                    th:each="i : ${#numbers.sequence(0, totalPages - 1)}"
                    th:classappend="${i == currentPage} ? 'active'">
                    <a class="page-link"
                       th:attr="hx-get=@{'/orders/filter'(page=${i}, keyword=${keyword}, status=${status},
                                                dateRange=${dateRange}, priceRange=${priceRange},
                                                sortField=${sortField}, sortDir=${sortDir}, size=${size})}"
                       hx-target="#orderTableContainer"
                       hx-swap="innerHTML"
                       th:text="${i + 1}">
                    </a>
                </li>

                <!-- Trang sau -->
                <li class="page-item" th:classappend="${currentPage + 1 >= totalPages} ? 'disabled'">
                    <a class="page-link"
                       th:attr="hx-get=@{'/orders/filter'(page=${currentPage + 1}, keyword=${keyword}, status=${status},
                                                dateRange=${dateRange}, priceRange=${priceRange},
                                                sortField=${sortField}, sortDir=${sortDir}, size=${size})}"
                       hx-target="#orderTableContainer"
                       hx-swap="innerHTML">
                        Sau
                    </a>
                </li>

                <!-- Dropdown ch·ªçn s·ªë b·∫£n ghi -->
                <li class="page-item ms-3 align-self-center">
                    <select name="size"
                            class="form-select w-auto pe-5"
                            hx-get="/orders/filter"
                            hx-target="#orderTableContainer"
                            hx-swap="innerHTML"
                            hx-include="[name='keyword'], [name='status'], [name='dateRange'], [name='priceRange'], [name='sortField'], [name='sortDir']">
                        <option value="5" th:selected="${size == 5}">5 b·∫£n ghi</option>
                        <option value="10" th:selected="${size == 10}">10 b·∫£n ghi</option>
                        <option value="20" th:selected="${size == 20}">20 b·∫£n ghi</option>
                    </select>
                </li>
            </ul>
        </nav>

    </div> <!-- end orderTableContainer -->

</div> <!-- end container -->

<!--Footer-->
<div th:replace="common/footer :: footer"></div>

<!-- htmx: th∆∞ vi·ªán gi√∫p c·∫≠p nh·∫≠t t·ª´ng ph·∫ßn HTML m√† kh√¥ng reload trang -->
<script src="https://unpkg.com/htmx.org@1.9.3"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>
