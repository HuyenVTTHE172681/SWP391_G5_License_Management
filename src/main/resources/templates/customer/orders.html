<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ƒê∆°n h√†ng c·ªßa t√¥i</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link th:href="@{/css/home.css}" rel="stylesheet">
    <style>
        td.text-start.align-middle {
            white-space: nowrap !important;  /* Kh√¥ng cho ph√©p xu·ªëng d√≤ng trong √¥ */
        }

        td.text-start.align-middle .btn,
        td.text-start.align-middle a,
        td.text-start.align-middle button {
            display: inline-flex;       /* icon + text n·∫±m c√πng d√≤ng */
            align-items: center;
            margin-right: 4px;          /* t·∫°o kho·∫£ng c√°ch gi·ªØa c√°c n√∫t */
            vertical-align: middle;
        }

        td.text-start.align-middle i {
            margin-right: 2px;
        }

        /* N·∫øu icon ‚Üí ch·ªØ, cho kho·∫£ng c√°ch nh·ªè gi·ªØa icon v√† ch·ªØ */
        .btn i {
            margin-right: 2px;
        }
        .custom-modal-height {
            height: 90vh; /* Chi·ªÅu cao t·ªëi ƒëa = 90% viewport */
            display: flex;
            flex-direction: column;
        }

        .custom-modal-height .modal-content {
            height: 100%;
        }
    </style>

</head>
<body>
<!--Header-->
<div th:replace="common/header :: header"></div>

<!--Body-->
<div class="container mt-5">
    <h3 class="text-center mb-4">üõí ƒê∆°n h√†ng ƒë√£ mua</h3>

    <!-- FORM L·ªåC & T√åM KI·∫æM -->
    <!-- hx-get: g·ªçi endpoint /orders/filter khi form submit -->
    <!-- hx-target: ph·∫ßn t·ª≠ s·∫Ω ƒë∆∞·ª£c thay th·∫ø n·ªôi dung -->
    <!-- hx-swap="innerHTML": ch·ªâ thay n·ªôi dung b√™n trong -->
    <form hx-get="/orders/filter"
          hx-target="#orderTableContainer"
          hx-trigger="submit"
          hx-swap="innerHTML"
          class="row g-2 mb-3">

        <!-- H√†ng 1: SEARCH - TR·∫†NG TH√ÅI - TH·ªúI GIAN - GI√Å -->
        <div class="row g-2 align-items-center mb-2">
            <div class="col-md-3">
                <input type="text" name="keyword" th:value="${keyword}" class="form-control"
                       placeholder="T√¨m theo m√£, tool, ng∆∞·ªùi b√°n, license...">
            </div>

            <div class="col-md-3">
                <select name="status" class="form-select">
                    <option value="">T·∫•t c·∫£ tr·∫°ng th√°i</option>
                    <option value="SUCCESS" th:selected="${status == 'SUCCESS'}">Th√†nh c√¥ng</option>
                    <option value="PENDING" th:selected="${status == 'PENDING'}">ƒêang x·ª≠ l√Ω</option>
                    <option value="FAILED" th:selected="${status == 'FAILED'}">Th·∫•t b·∫°i</option>
                </select>
            </div>

            <div class="col-md-3">
                <select name="dateRange" class="form-select">
                    <option value="">M·ªçi th·ªùi gian</option>
                    <option value="7" th:selected="${dateRange == '7'}">7 ng√†y g·∫ßn ƒë√¢y</option>
                    <option value="30" th:selected="${dateRange == '30'}">1 th√°ng g·∫ßn ƒë√¢y</option>
                    <option value="90" th:selected="${dateRange == '90'}">3 th√°ng g·∫ßn ƒë√¢y</option>
                </select>
            </div>

            <div class="col-md-3">
                <select name="priceRange" class="form-select">
                    <option value="">M·ªçi gi√°</option>
                    <option value="0-100000" th:selected="${priceRange == '0-100000'}">D∆∞·ªõi 100.000</option>
                    <option value="100000-500000" th:selected="${priceRange == '100000-500000'}">100.000 - 500.000</option>
                    <option value="500000-1000000" th:selected="${priceRange == '500000-1000000'}">500.000 - 1.000.000</option>
                    <option value="1000000+" th:selected="${priceRange == '1000000+'}">Tr√™n 1.000.000</option>
                </select>
            </div>
        </div>

        <!-- H√†ng 2: SORT + DIRECTION + BUTTONS -->
        <div class="row g-2 justify-content-left align-items-center">
            <div class="col-md-2">
                <select name="sortField" class="form-select pe-5">
                    <option value="createdAt" th:selected="${sortField == 'createdAt'}">Ng√†y mua</option>
                    <option value="price" th:selected="${sortField == 'price'}">ƒê∆°n gi√°</option>
                    <option value="orderId" th:selected="${sortField == 'orderId'}">M√£ ƒë∆°n h√†ng</option>
                </select>
            </div>

            <div class="col-md-2">
                <select name="sortDir" class="form-select text-left">
                    <option value="desc" th:selected="${sortDir == 'desc'}">Gi·∫£m d·∫ßn</option>
                    <option value="asc" th:selected="${sortDir == 'asc'}">TƒÉng d·∫ßn</option>
                </select>
            </div>

            <div class="col-md-auto">
                <button type="submit" class="btn btn-primary px-4">
                    <i class="bi bi-search"></i> T√¨m ki·∫øm
                </button>
            </div>

            <div class="col-md-auto">
                <a href="/orders" class="btn btn-secondary px-4">
                    <i class="bi bi-x-circle"></i> X√≥a l·ªçc
                </a>
            </div>
        </div>
    </form>

    <!-- Th√¥ng b√°o -->
    <div th:if="${message}" class="alert alert-info alert-dismissible fade show mt-2" role="alert">
        <span th:text="${message}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <div th:if="${error}" class="alert alert-danger alert-dismissible fade show mt-2" role="alert">
        <span th:text="${error}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>


    <!-- DANH S√ÅCH ƒê∆†N H√ÄNG -->
    <div id="orderTableContainer" th:fragment="orderTableFragment">

        <!-- N·∫øu kh√¥ng c√≥ d·ªØ li·ªáu -->
        <div th:if="${ordersPage == null or ordersPage.isEmpty()}"
             class="alert alert-warning text-center">
            Kh√¥ng c√≥ ƒë∆°n h√†ng n√†o ph√π h·ª£p v·ªõi b·ªô l·ªçc.
        </div>

        <!-- N·∫øu c√≥ d·ªØ li·ªáu, hi·ªÉn th·ªã b·∫£ng -->
        <table class="table table-bordered table-hover align-middle">
            <thead class="table-primary text-center">
            <tr>
                <th>M√£ ƒë∆°n h√†ng</th>
                <th>Ng√†y mua</th>
                <th>Ng∆∞·ªùi b√°n</th>
                <th>M·∫∑t h√†ng</th>
                <th>G√≥i</th>
                <th>ƒê∆°n gi√°</th>
                <th>Tr·∫°ng th√°i</th>
                <th>H√†nh ƒë·ªông</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="order : ${ordersPage.content}">
                <td th:text="${order.orderId}"></td>
                <td th:text="${#temporals.format(order.createdAt, 'dd/MM/yyyy HH:mm')}"></td>
                <td th:text="${order.tool.seller.fullName}"></td>
                <td th:text="${order.tool.toolName}"></td>
                <td th:text="${order.license.name}"></td>
                <td th:text="${#numbers.formatDecimal(order.price, 0, 'COMMA', 0, 'POINT')} + ' VND'"></td>
                <td class="text-center">
                                <span th:switch="${order.orderStatus.name()}">
                                    <span th:case="'PENDING'" class="badge bg-warning">Ch·ªù thanh to√°n</span>
                                    <span th:case="'SUCCESS'" class="badge bg-success">Th√†nh c√¥ng</span>
                                    <span th:case="'FAILED'" class="badge bg-danger">Th·∫•t b·∫°i</span>
                                    <span th:case="*">Kh√¥ng x√°c ƒë·ªãnh</span>
                                </span>
                </td>
                <td class="text-start align-middle">
                    <!-- Xem chi ti·∫øt -->
                    <a th:href="@{/orders/{id}(id=${order.orderId})}"
                       th:attr="hx-get=@{/orders/{id}(id=${order.orderId})}"
                       class="btn btn-sm btn-primary"
                       title="Xem chi ti·∫øt"
                       hx-target="#orderDetailModalBody"
                       hx-trigger="click"
                       hx-swap="innerHTML">
                        <i class="bi bi-eye"></i>
                    </a>
                    <!-- G∆∞i Feedback  -->
                    <span th:if="${order.orderStatus.name() == 'SUCCESS'}">
                        <span th:if="${order.canFeedbackOrReport}">
                            <a class="btn btn-sm btn-warning"
                                th:href="@{|/orders/${order.orderId}/feedback|}">
                                Feedback
                            </a>
                        </span>
                    </span>
                    <!-- B√°o c√°o  -->
                    <span th:if="${order.orderStatus.name() == 'SUCCESS'}">
                        <span th:if="${order.canFeedbackOrReport}">
                            <button type="button"
                                    class="btn btn-outline-danger btn-sm"
                                    data-bs-toggle="modal"
                                    data-bs-target="#reportToolModal"
                                    th:attr="data-tool-id=${order.tool.toolId}">
                                <i class="bi bi-flag-fill me-1"></i> B√°o c√°o
                            </button>
                        </span>
                    </span>
                    <!-- D√πng d·ªãch v·ª• -->
                    <a th:if="${order.orderStatus.name() == 'SUCCESS'}"
                       th:href="@{'/my-tools/' + ${order.orderId}}"
                       class="btn btn-sm btn-success"
                       th:disabled="${!order.canFeedbackOrReport}">
                        <i class="bi bi-arrow-right"></i> D√πng d·ªãch v·ª•
                    </a>
                    <!-- PENDING: Thanh to√°n l·∫°i -->
                    <a th:if="${order.orderStatus.name() == 'PENDING'}"
                       th:href="@{'/payment/create?toolId=' + ${order.tool.toolId} + '&licenseId=' + ${order.license.licenseId} + '&orderId=' + ${order.orderId}}"
                       class="btn btn-sm btn-info">
                        <i class="bi bi-credit-card"></i> Thanh to√°n l·∫°i
                    </a>
                </td>
            </tr>
            </tbody>
        </table>

        <!-- Ph√¢n trang -->
        <nav th:if="${totalPages >= 1}">
            <ul class="pagination justify-content-center align-items-center">

                <!-- Trang tr∆∞·ªõc -->
                <li class="page-item" th:classappend="${currentPage == 0} ? 'disabled'">
                    <a class="page-link"
                       th:attr="hx-get=@{'/orders/filter'(page=${currentPage - 1}, keyword=${keyword}, status=${status},
                                                dateRange=${dateRange}, priceRange=${priceRange},
                                                sortField=${sortField}, sortDir=${sortDir}, size=${size})}"
                       hx-target="#orderTableContainer"
                       hx-swap="innerHTML">
                        Tr∆∞·ªõc
                    </a>
                </li>

                <!-- C√°c s·ªë trang -->
                <li class="page-item"
                    th:each="i : ${#numbers.sequence(0, totalPages - 1)}"
                    th:classappend="${i == currentPage} ? 'active'">
                    <a class="page-link"
                       th:attr="hx-get=@{'/orders/filter'(page=${i}, keyword=${keyword}, status=${status},
                                                dateRange=${dateRange}, priceRange=${priceRange},
                                                sortField=${sortField}, sortDir=${sortDir}, size=${size})}"
                       hx-target="#orderTableContainer"
                       hx-swap="innerHTML"
                       th:text="${i + 1}">
                    </a>
                </li>

                <!-- Trang sau -->
                <li class="page-item" th:classappend="${currentPage + 1 >= totalPages} ? 'disabled'">
                    <a class="page-link"
                       th:attr="hx-get=@{'/orders/filter'(page=${currentPage + 1}, keyword=${keyword}, status=${status},
                                                dateRange=${dateRange}, priceRange=${priceRange},
                                                sortField=${sortField}, sortDir=${sortDir}, size=${size})}"
                       hx-target="#orderTableContainer"
                       hx-swap="innerHTML">
                        Sau
                    </a>
                </li>

                <!-- Dropdown ch·ªçn s·ªë b·∫£n ghi -->
                <li class="page-item ms-3 align-self-center">
                    <select name="size"
                            class="form-select w-auto pe-5"
                            hx-get="/orders/filter"
                            hx-target="#orderTableContainer"
                            hx-swap="innerHTML"
                            hx-include="[name='keyword'], [name='status'], [name='dateRange'], [name='priceRange'], [name='sortField'], [name='sortDir']">
                        <option value="5" th:selected="${size == 5}">5 b·∫£n ghi</option>
                        <option value="10" th:selected="${size == 10}">10 b·∫£n ghi</option>
                        <option value="20" th:selected="${size == 20}">20 b·∫£n ghi</option>
                    </select>
                </li>
            </ul>
        </nav>
    </div> <!-- end orderTableContainer -->
</div> <!-- end container -->
<!--Footer-->
<div th:replace="common/footer :: footer"></div>

<!-- TH√äM M·ªöI: MODAL CHI TI·∫æT ORDER -->
<div class="modal fade" id="orderDetailModal" tabindex="-1" aria-labelledby="orderDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="orderDetailModalLabel">Chi ti·∫øt ƒë∆°n h√†ng</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="orderDetailModalBody">
                <!-- HTMX load fragment v√†o ƒë√¢y -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
            </div>
        </div>
    </div>
</div>

<div th:fragment="orderDetailModal" th:if="${order != null}">
    <div class="order-detail p-3">
        <div class="border rounded p-3 mb-3">
            <div class="row">
                <div class="col-md-6">
                    <h6 class="text-muted mb-3">M√£ ƒë∆°n: <b th:text="${order.orderId}">DH001</b></h6>
                    <h6 class="mb-3"><i class="bi bi-calendar3"></i> Ng√†y mua:
                        <span th:text="${#temporals.format(order.createdAt, 'dd/MM/yyyy HH:mm')}"></span>
                    </h6>
                    <!-- Seller info -->
                    <div class="mb-3">
                        <h6 th:text="'üë§ ' + ${order.tool.seller.fullName}"></h6>
                        <div>
                        <span th:each="i : ${#numbers.sequence(1, 5)}">
                            <i th:class="${i <= sellerRating ? 'fas fa-star text-warning' : 'far fa-star text-muted'}"></i>
                        </span>
                            <small class="text-muted" th:text="${#numbers.formatDecimal(sellerRating,1,1)} + '/5'">4.8/5</small>
                        </div>
                    </div>

                </div>
                <div class="col-md-6 text-md-end">
                    <h6>Tr·∫°ng th√°i:
                        <span th:switch="${order.orderStatus.name()}">
                            <span th:case="'SUCCESS'" class="badge bg-success">Th√†nh c√¥ng</span>
                            <span th:case="'PENDING'" class="badge bg-warning text-dark">Ch·ªù thanh to√°n</span>
                            <span th:case="'FAILED'" class="badge bg-danger">Th·∫•t b·∫°i</span>
                        </span>
                    </h6>
                </div>
            </div>
        </div>

        <!-- Product info -->
        <div class="border rounded p-3 mb-3">
            <div class="row">
                <div class="col-md-8">
                    <h6 class="fw-bold" th:text="${order.tool.toolName}">Email Bulk Sender Pro</h6>
                    <p class="text-muted mb-6" th:text="${order.tool.description}">C√¥ng c·ª• g·ª≠i email h√†ng lo·∫°t chuy√™n nghi·ªáp</p>
                    <div class="col-md-5 mb-2"><strong>Category:</strong> <span th:text="${order.tool.category.categoryName}"></span></div>
                    <div class="col-md-8 mb-2">
                        <strong>G√≥i:</strong>
                        <span th:text="${order.license.name}"></span>
                        <span class="text-muted fst-italic">(
                        <span th:text="${order.license.durationDays}"></span> ng√†y)</span>
                    </div>
<!--                    <div class="col-md-8 mb-2">-->
<!--                        <strong>H·∫°n s·ª≠ d·ª•ng: </strong><span class="fw-bold text-danger" th:text="${#temporals.format(order.licenseAccount.endDate, 'dd/MM/yyyy HH:mm')}"></span>-->
<!--                    </div>-->
                    <div class="col-md-8 mb-2" th:if="${order.licenseAccount != null and order.licenseAccount.endDate != null}">
                        <strong>H·∫°n s·ª≠ d·ª•ng: </strong><span class="fw-bold text-danger" th:text="${#temporals.format(order.licenseAccount.endDate, 'dd/MM/yyyy HH:mm')}"></span>
                    </div>
                    <div class="col-md-8 mb-2" th:if="${order.licenseAccount == null or order.licenseAccount.endDate == null}">
                        <strong>H·∫°n s·ª≠ d·ª•ng: </strong><span class="text-muted">Ch∆∞a x√°c ƒë·ªãnh (ƒë∆°n h√†ng ch∆∞a ho√†n t·∫•t)</span>
                    </div>
                    <div class="col-md-4"><strong>Gi√°:</strong> <span class="fw-bold text-success" th:text="${#numbers.formatDecimal(basePrice,0,'COMMA',0,'POINT')} + ' VND'"></span></div>
                </div>
                <div class="col-md-4 text-center">
                    <img th:src="${order.tool.image}" alt="Tool image" class="img-fluid rounded">
                </div>
            </div>
        </div>

        <!-- Actions -->
        <div class="d-flex justify-content-end gap-2">
            <a th:if="${order.orderStatus.name() == 'SUCCESS'}"
               th:href="@{|/orders/${order.orderId}/feedback|}"
               class="btn btn-warning"><i class="bi bi-chat-left-dots"></i> G·ª≠i Feedback</a>
<!--            <a th:if="${order.orderStatus.name() == 'SUCCESS'}"-->
<!--               th:href="@{|/orders/${order.orderId}/report|}"-->
<!--               class="btn btn-outline-danger"><i class="bi bi-flag"></i> B√°o c√°o</a>-->
            <a th:if="${order.orderStatus.name() == 'SUCCESS'}"
               th:href="@{'/my-tools/' + ${order.orderId}}"
               class="btn btn-success"><i class="bi bi-play-circle"></i> D√πng d·ªãch v·ª• n√†y</a>
        </div>
    </div>
</div>

<!-- TH√äM M·ªöI: Modal B√°o c√°o -->
<div class="modal fade" id="reportToolModal" tabindex="-1" aria-labelledby="reportToolModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg custom-report-modal">
        <div class="modal-content shadow-lg border-0 rounded-4">
            <form id="reportForm" method="post">
                <div class="modal-header bg-danger text-white rounded-top-4">
                    <h5 class="modal-title" id="reportToolModalLabel">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i> B√°o c√°o c√¥ng c·ª•
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label fw-semibold">L√Ω do</label>
                        <select name="reason" class="form-select" required>
                            <option value="">-- Ch·ªçn l√Ω do --</option>
                            <option value="SPAM">Spam</option>
                            <option value="MALICIOUS_CONTENT">N·ªôi dung ƒë·ªôc h·∫°i</option>
                            <option value="COPYRIGHT_VIOLATION">Vi ph·∫°m b·∫£n quy·ªÅn</option>
                            <option value="INAPPROPRIATE_CONTENT">N·ªôi dung kh√¥ng ph√π h·ª£p</option>
                            <option value="MISLEADING_INFO">Th√¥ng tin sai l·ªách</option>
                            <option value="IRRELEVANT_CATEGORY">Danh m·ª•c kh√¥ng ph√π h·ª£p</option>
                            <option value="OTHER">Kh√°c</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-semibold">M√¥ t·∫£ th√™m</label>
                        <textarea name="description" class="form-control" rows="3"
                                  placeholder="H√£y m√¥ t·∫£ chi ti·∫øt l√Ω do b·∫°n b√°o c√°o..."></textarea>
                    </div>
                </div>

                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-send-fill me-1"></i> G·ª≠i b√°o c√°o
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
<!-- JS cho Modal (show sau HTMX load) -->
<script>
    // Hi·ªÉn th·ªã modal chi ti·∫øt sau khi HTMX load
    document.body.addEventListener('htmx:afterSwap', function(evt) {
        if (evt.detail.target.id === 'orderDetailModalBody') {
            var modal = new bootstrap.Modal(document.getElementById('orderDetailModal'));
            modal.show();
        }
    });

    // Fallback if no HTMX (direct href)
    function showOrderModal(id) {
        window.location.href = '/orders/' + id;
    }

    // Thi·∫øt l·∫≠p form b√°o c√°o
    document.addEventListener('DOMContentLoaded', () => {
        const modal = document.getElementById('reportToolModal');
        const form = document.getElementById('reportForm');

        modal.addEventListener('show.bs.modal', event => {
            const button = event.relatedTarget;
            const toolId = button.getAttribute('data-tool-id');
            form.action = `/tools/${toolId}/report`;
        });

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(form);
            const url = form.action;

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    body: formData
                });

                const message = await response.text();

                if (response.ok) {
                    alert(message);
                } else if (response.status === 409) {
                    alert(message); // ƒë√£ b√°o c√°o tr∆∞·ªõc ƒë√≥
                } else if (response.status === 401) {
                    alert(message); // ch∆∞a ƒëƒÉng nh·∫≠p
                    window.location.href = "/login";
                } else {
                    alert(message);
                }

                const bsModal = bootstrap.Modal.getInstance(modal);
                bsModal.hide();
                form.reset();

            } catch (err) {
                alert(err.message);
            }
        });
    });
</script>

<!-- htmx: th∆∞ vi·ªán gi√∫p c·∫≠p nh·∫≠t t·ª´ng ph·∫ßn HTML m√† kh√¥ng reload trang -->
<script src="https://unpkg.com/htmx.org@1.9.3"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>