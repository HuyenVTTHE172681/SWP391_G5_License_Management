<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Edit Tool</title>

    <style>
        body {
            background-color: #f9fafb;
            font-family: 'Segoe UI', Tahoma, sans-serif;
            margin: 0;
            padding: 0;
        }

        .form-section {
            max-width: 700px;
            margin: 2rem auto;
            background-color: white;
            padding: 2rem;
            border-radius: 16px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        .back-btn {
            background-color: #e5e7eb;
            color: #374151;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 500;
            transition: 0.2s;
        }
        .back-btn:hover { background-color: #d1d5db; }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            font-weight: 500;
            color: #374151;
            margin-bottom: 0.4rem;
        }

        .form-input,
        .form-select,
        .form-textarea,
        .form-control {
            width: 100%;
            height: 45px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            padding: 0.6rem 0.75rem;
            font-size: 1rem;
            background-color: #fff;
            outline: none;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
            box-sizing: border-box;
        }

        .form-control[type="file"] { padding: 7px; }

        textarea.form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus,
        .form-control:focus {
            border-color: #16a34a;
            box-shadow: 0 0 0 2px rgba(34,197,94,0.3);
        }

        .submit-btn {
            background-color: #16a34a;
            color: white;
            border: none;
            padding: 0.6rem 1.5rem;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .submit-btn:hover { background-color: #15803d; }

        /* ‚úÖ Preview Image */
        .preview-img {
            width: 140px;
            height: 140px;
            object-fit: cover;
            border-radius: 10px;
            border: 1px solid #d1d5db;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            margin-top: 8px;
            transition: transform 0.2s ease;
        }
        .preview-img:hover { transform: scale(1.03); }
    </style>
</head>

<body>

<div style="max-width: 700px; margin: 1rem auto;">
    <a href="/seller/tools" class="back-btn">‚Üê Back</a>
</div>

<section class="form-section">
    <h2>Edit Tool</h2>
    <form th:action="@{'/seller/tools/edit/' + ${tool.toolId}}" th:object="${tool}" method="post" enctype="multipart/form-data">

        <!-- üßæ Tool Name -->
        <div class="form-group">
            <label class="form-label">Tool Name</label>
            <input type="text" th:field="*{tool.toolName}" class="form-input">
        </div>

        <!-- üñº Current Image -->
        <div class="form-group">
            <label class="form-label">Current Image</label>
            <img th:src="@{'/uploads/tools/' + ${tool.image}}"
                 alt="Current Image"
                 class="preview-img"
                 onerror="this.src='/uploads/tools/default-placeholder.png'">
        </div>

        <!-- üñº Change / Select Image -->
        <div class="form-group">
            <label class="form-label">Change Image</label>
            <input type="file" name="imageFile" id="imageFile" class="form-control" accept="image/*">
            <p style="margin:8px 0;">Or choose existing image:</p>
            <select name="existingImage" id="existingImage" class="form-select">
                <option value="">-- Select existing image --</option>
                <option th:each="img : ${existingImages}" th:value="${img}" th:text="${img}"></option>
            </select>
            <div class="text-center">
                <img id="previewImage" class="preview-img" style="display:none;">
            </div>
        </div>

        <!-- üíæ Tool File -->
        <div class="form-group">
            <label class="form-label">Change Tool File (.exe, .zip, .rar)</label>
            <input type="file" name="toolFile" class="form-input" accept=".exe,.zip,.rar">
        </div>

        <!-- üóÇ Category -->
        <div class="form-group">
            <label class="form-label">Category</label>
            <select th:field="*{category.categoryId}" class="form-select">
                <option value="">-- Select category --</option>
                <option th:each="c : ${categories}" th:value="${c.categoryId}" th:text="${c.categoryName}"
                        th:selected="${tool.category?.categoryId == c.categoryId}"></option>
            </select>
        </div>

        <!-- üìù Description -->
        <div class="form-group">
            <label class="form-label">Description</label>
            <textarea th:field="*{tool.description}" class="form-textarea"></textarea>
        </div>
        <div class="form-group mt-3">
            <label class="form-label" for="loginMethod">Login Method</label>

            <!-- ‚úÖ Hi·ªÉn th·ªã d·∫°ng ch·ªâ xem -->
            <input type="text" id="loginMethod" class="form-control"
                   th:value="${tool.loginMethod?.name() == 'USER_PASSWORD' ? 'Username & Password' : 'Token-based'}"
                   readonly>

            <!-- ‚úÖ Hidden input g·ª≠i gi√° tr·ªã th·∫≠t l√™n controller -->
            <input type="hidden" name="loginMethod" th:value="${tool.loginMethod?.name()}">
        </div>

        <!-- üî¢ Quantity -->
        <div class="form-group">
            <label class="form-label">Quantity</label>
            <input type="number" th:field="*{tool.quantity}" class="form-input" min="1">
        </div>

        <div class="form-group">
            <label class="form-label">Pricing Options</label>
            <div id="licenseContainer">

                <!-- üü¢ Hi·ªÉn th·ªã c√°c license c≈© -->
                <div th:each="i : ${#numbers.sequence(0, licenseDays.size() - 1)}"
                     class="license-row" style="display:flex; gap:10px;">
                    <input type="number" name="licenseDays" min="1" placeholder="Days"
                           class="form-input" style="flex:1;"
                           th:value="${licenseDays[i]}" />

                    <input type="number" name="licensePrices" min="0" placeholder="Price (VNƒê)"
                           class="form-input" style="flex:1;"
                           th:value="${licensePrices[i]}" />

                    <button type="button" class="remove-btn" onclick="removeLicenseRow(this)">√ó</button>
                </div>
            </div>
            <button type="button" onclick="addLicenseRow()" style="margin-top:8px;">+ Add another</button>
            <small id="licenseError" class="error-message" style="display:none;">Each pricing row must have both Days and Price.</small>
        </div>

        <!-- ‚úÖ Submit -->
        <div style="text-align:right;">
            <!-- N·∫øu loginMethod l√† USER_PASSWORD th√¨ l∆∞u tr·ª±c ti·∫øp -->
            <button type="submit"
                    th:if="${tool.loginMethod?.name() == 'USER_PASSWORD'}"
                    class="submit-btn">
                üíæ Save Changes
            </button>

            <!-- N·∫øu loginMethod l√† TOKEN th√¨ chuy·ªÉn sang token manager -->
            <button type="button"
                    th:if="${tool.loginMethod?.name() == 'TOKEN'}"
                    class="submit-btn"
                    th:onclick="|window.location.href='/seller/tokens/manage?toolId=' + [[${tool.toolId}]]|">
                ‚û°Ô∏è Next
            </button>
        </div>
    </form>
</section>

<script>
    // Hi·ªÉn th·ªã preview khi ch·ªçn ·∫£nh t·ª´ file
    document.getElementById('imageFile').addEventListener('change', e => {
        const file = e.target.files[0];
        const preview = document.getElementById('previewImage');
        if (file) {
            const reader = new FileReader();
            reader.onload = ev => {
                preview.src = ev.target.result;
                preview.style.display = 'block';
            };
            reader.readAsDataURL(file);
        } else preview.style.display = 'none';
    });

    // Hi·ªÉn th·ªã preview khi ch·ªçn ·∫£nh c√≥ s·∫µn
    document.getElementById('existingImage').addEventListener('change', e => {
        const name = e.target.value;
        const preview = document.getElementById('previewImage');
        if (name) {
            preview.src = '/uploads/tools/' + name;
            preview.style.display = 'block';
        } else preview.style.display = 'none';
    });

    // Th√™m license m·ªõi
    function addLicenseRow() {
        const container = document.getElementById('licenseContainer');
        const row = document.createElement('div');
        row.classList.add('license-row');
        row.innerHTML = `
    <input type="number" name="licenseDays" min="1" placeholder="Days" class="form-input" style="flex:1;">
    <input type="number" name="licensePrices" min="0" placeholder="Price (VNƒê)" class="form-input" style="flex:1;">
    <button type="button" class="remove-btn" onclick="removeLicenseRow(this)">√ó</button>
  `;
        container.appendChild(row);
    }
    function removeLicenseRow(button) {
        const container = document.getElementById('licenseContainer');
        const rows = container.getElementsByClassName('license-row');

        // ‚úÖ Ch·ªâ cho ph√©p x√≥a n·∫øu c√≤n nhi·ªÅu h∆°n 1 d√≤ng
        if (rows.length > 1) {
            button.closest('.license-row').remove();
        } else {
            alert("At least one pricing option is required.");
        }
    }

    // ‚úÖ ƒê·∫£m b·∫£o h√†m ho·∫°t ƒë·ªông sau khi DOM load xong
    document.addEventListener("DOMContentLoaded", function() {
        const removeButtons = document.querySelectorAll(".remove-btn");
        removeButtons.forEach(btn => {
            btn.addEventListener("click", function() {
                removeLicenseRow(btn);
            });
        });
    });
</script>

</body>
</html>
