<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8">
    <title>Edit Tool</title>
    <link rel="stylesheet" th:href="@{/css/tool-edit.css}">
</head>
<body>

<div class="container">
    <!-- Header -->
    <div class="page-header">
        <h1 class="page-title">Edit Tool</h1>
        <a th:href="@{/seller/tools}" class="back-btn">‚Üê Back</a>
    </div>

    <!-- Alerts -->
    <div th:if="${success}" class="alert alert-success" th:text="${success}"></div>
    <div th:if="${error}" class="alert alert-error" th:text="${error}"></div>
    <div th:if="${info}" class="alert alert-info" th:text="${info}"></div>

    <!-- Form -->
    <form th:action="@{|/seller/tools/edit/${tool.toolId}|}"
          th:object="${tool}"
          method="post"
          enctype="multipart/form-data">

        <div class="form-group">
            <label class="form-label">Tool Name</label>
            <input type="text" th:field="*{toolName}" class="form-input" placeholder="Enter tool name" required>
        </div>

        <div class="form-group">
            <label class="form-label">Upload Image</label>
            <input type="file" name="imageFile" class="form-control" accept="image/png,image/jpeg" onchange="previewImg(event)">
            <img id="imgPreview"
                 class="preview-img"
                 th:if="${tool.image != null}"
                 th:src="@{'/' + ${tool.image}}"
                 alt="Current tool image">
        </div>

        <div class="form-group">
            <label class="form-label">Upload Tool File (.exe, .zip, .rar)</label>
            <input type="file" name="toolFile" class="form-control" accept=".exe,.zip,.rar">
        </div>

        <div class="form-group">
            <label class="form-label">Category</label>
            <select th:field="*{category.categoryId}" class="form-select" required>
                <option value="">-- Select category --</option>
                <option th:each="c : ${categories}" th:value="${c.categoryId}" th:text="${c.categoryName}"></option>
            </select>
        </div>

        <div class="form-group">
            <label class="form-label">Description</label>
            <textarea th:field="*{description}" class="form-textarea" placeholder="Enter description" required></textarea>
        </div>

        <div class="form-group">
            <label class="form-label">Login Method</label>
            <input class="form-input" th:value="*{loginMethod}" readonly>
            <input type="hidden" th:field="*{loginMethod}">
        </div>

        <!-- ‚úÖ Quantity: Lock khi l√† TOKEN -->
        <div class="form-group">
            <label class="form-label">Quantity</label>
            <input type="number"
                   th:field="*{quantity}"
                   class="form-input"
                   min="0"
                   required
                   th:attr="readonly=${tool.loginMethod.name() == 'TOKEN'}">
            <small th:if="${tool.loginMethod.name() == 'TOKEN'}" class="text-muted">
                üîí Locked ‚Äî quantity will update when click <b>Finalize Tokens</b>.
            </small>
            <small th:if="${tool.loginMethod.name() != 'TOKEN'}" class="text-muted">
            </small>
        </div>

        <div class="form-group">
            <label class="form-label">License Packages</label>
            <div id="licenseContainer">
                <div class="license-row" th:each="lic : ${tool.licenses}">
                    <input type="number" name="licenseDays" th:value="${lic.durationDays}" class="form-input" placeholder="Days" min="1" required>
                    <input type="number" name="licensePrices" th:value="${lic.price}" class="form-input" placeholder="Price (VND)" min="0" required>
                    <button type="button" class="remove-btn" onclick="removeRow(this)">√ó</button>
                </div>
            </div>
            <button type="button" class="add-btn" onclick="addRow()">+ Add another</button>
        </div>

        <div class="form-actions">
            <a th:href="@{/seller/tools}" class="cancel-btn">Cancel</a>

            <!-- TOKEN tool -->
            <button th:if="${isTokenLogin}"
                    type="submit"
                    name="action"
                    value="token"
                    class="submit-btn"
                    style="background:#f59e0b;">Next ‚Üí Tokens</button>

            <!-- USER_PASSWORD tool -->
            <button th:if="${!isTokenLogin}"
                    type="submit"
                    name="action"
                    value="save"
                    class="submit-btn">Save Changes</button>
        </div>
    </form>
</div>

<script>
    function previewImg(e) {
        const file = e.target.files[0];
        const img = document.getElementById("imgPreview");
        if (!file || !img) return;
        const reader = new FileReader();
        reader.onload = ev => img.src = ev.target.result;
        reader.readAsDataURL(file);
    }

    function addRow() {
        const container = document.getElementById("licenseContainer");
        const row = document.createElement("div");
        row.className = "license-row";
        row.innerHTML = `
            <input type="number" name="licenseDays" class="form-input" placeholder="Days" min="1" required>
            <input type="number" name="licensePrices" class="form-input" placeholder="Price (VND)" min="0" required>
            <button type="button" class="remove-btn" onclick="removeRow(this)">√ó</button>
        `;
        container.appendChild(row);
    }

    function removeRow(btn) {
        const container = document.getElementById("licenseContainer");
        if (container.children.length <= 1) {
            alert("C·∫ßn √≠t nh·∫•t 1 license!");
            return;
        }
        btn.closest(".license-row").remove();
    }

    // ‚úÖ JS fallback: n·∫øu loginMethod = TOKEN, lock quantity
    document.addEventListener("DOMContentLoaded", () => {
        const loginInput = document.querySelector('input[name="loginMethod"]');
        const quantityInput = document.querySelector('input[name="quantity"]');
        if (loginInput && quantityInput && loginInput.value === 'TOKEN') {
            quantityInput.readOnly = true;
        }
    });
</script>
</body>
</html>
