<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Feedback từ khách hàng</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link th:href="@{/webjars/bootstrap/5.3.2/css/bootstrap.min.css}" rel="stylesheet"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link th:href="@{/css/seller-feedback.css}" rel="stylesheet"/>
</head>
<body class="bg-light">
<div class="container py-4">
    <div class="page-header d-flex align-items-center justify-content-between mb-3">
        <h3 class="mb-0">Feedback từ khách hàng</h3>
        <a class="btn btn-outline-secondary" th:href="@{/seller/tools}">
            <i class="bi bi-arrow-left"></i>
            <span class="d-none d-sm-inline">Quay lại</span>
        </a>
    </div>

    <!-- Bộ lọc theo tool -->
    <form class="row g-2 align-items-end mb-3" method="get" th:action="@{/seller/feedback}">
        <div class="col-auto">
            <label class="form-label" for="toolIdInput">Tool ID</label>
            <input id="toolIdInput" type="number" min="1" class="form-control" name="toolId" th:value="${toolId}">
        </div>
        <div class="col-auto">
            <button class="btn btn-primary">
                <i class="bi bi-funnel"></i> Lọc
            </button>
            <a class="btn btn-outline-secondary" th:href="@{/seller/feedback}">Xóa lọc</a>
        </div>
    </form>

    <!-- backUrl = URL trang hiện tại (giữ toolId nếu đang lọc) -->
    <div class="card shadow-sm"
         th:with="backUrl=${toolId != null} ? @{/seller/feedback(toolId=${toolId})} : @{/seller/feedback}">
        <div class="table-responsive">
            <table class="table table-hover mb-0 align-middle feedback-table">
                <thead class="table-light">
                <tr>
                    <th class="w-date">Ngày</th>
                    <th class="w-tool">Tool</th>
                    <th class="w-customer">Khách</th>
                    <th>Rating / Comment</th>
                    <th class="w-reply">Phản hồi của Seller</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="fb : ${feedbacks}">
                    <td th:text="${#temporals.format(fb.createdAt, 'dd/MM/yyyy HH:mm')}">01/10/2025 12:00</td>

                    <td>
                        <div class="tool-line">
                            <a th:href="@{/tools/{id}(id=${fb.tool.toolId})}"
                               th:text="${fb.tool != null ? fb.tool.toolName : 'Tool'}">Tool name</a>
                        </div>
                        <div class="text-muted small">
                            ID: <span th:text="${fb.tool != null ? fb.tool.toolId : '—'}">1</span>
                        </div>
                    </td>

                    <td>
                        <div th:text="${fb.account.fullName}">Nguyễn Văn A</div>
                        <div class="text-muted small" th:text="${fb.account.email}">email@example.com</div>
                    </td>

                    <td>
                        <div class="stars">
                            <i th:each="i : ${#numbers.sequence(1,5)}"
                               class="bi bi-star-fill star"
                               th:classappend="${i <= fb.rating} ? '' : ' gray'"></i>
                            <span class="ms-2 badge text-bg-light" th:text="|${fb.rating}/5|">5/5</span>
                        </div>
                        <div th:text="${fb.comment}" class="mt-1"></div>
                    </td>

                    <td>
                        <div th:with="r=${@feedBackReplyRepository.findByFeedback_FeedbackId(fb.feedbackId).orElse(null)}">

                            <!-- ĐÃ CÓ REPLY -->
                            <div th:if="${r != null}">
                                <div class="p-3 rounded reply-card">
                                    <div class="d-flex justify-content-between gap-3 flex-wrap">
                                        <strong class="reply-title">
                                            <i class="bi bi-reply"></i> Phản hồi
                                        </strong>
                                        <small class="text-muted"
                                               th:text="|Cập nhật: ${#temporals.format(r.updatedAt, 'dd/MM/yyyy HH:mm')}|">
                                            Cập nhật: --
                                        </small>
                                    </div>
                                    <div class="mt-2" th:text="${r.content}">Nội dung phản hồi…</div>

                                    <form class="mt-2 d-inline"
                                          th:action="@{/seller/feedback/{fid}/reply/delete(fid=${fb.feedbackId})}"
                                          method="post">
                                        <input th:if="${_csrf != null}" type="hidden"
                                               th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                                        <!-- Ở lại trang hiện tại -->
                                        <input type="hidden" name="redirect" th:value="${backUrl}"/>
                                        <button class="btn btn-sm btn-outline-danger"
                                                onclick="return confirm('Xóa phản hồi này?')">
                                            <i class="bi bi-trash"></i> Xóa phản hồi
                                        </button>
                                    </form>
                                </div>

                                <!-- Form sửa -->
                                <details class="mt-2">
                                    <summary class="text-primary pointer">Sửa phản hồi</summary>
                                    <form class="mt-2"
                                          th:action="@{/seller/feedback/{fid}/reply(fid=${fb.feedbackId})}"
                                          method="post">
                                        <input th:if="${_csrf != null}" type="hidden"
                                               th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                                        <!-- Ở lại trang hiện tại -->
                                        <input type="hidden" name="redirect" th:value="${backUrl}"/>
                                        <textarea name="content" class="form-control" rows="3" maxlength="200"
                                                  th:text="${r.content}"></textarea>
                                        <div class="text-end mt-2">
                                            <button class="btn btn-sm btn-primary">
                                                <i class="bi bi-save"></i> Lưu
                                            </button>
                                        </div>
                                    </form>
                                </details>
                            </div>

                            <!-- CHƯA CÓ REPLY -->
                            <div th:if="${r == null}">
                                <form th:action="@{/seller/feedback/{fid}/reply(fid=${fb.feedbackId})}" method="post">
                                    <input th:if="${_csrf != null}" type="hidden"
                                           th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                                    <!-- Ở lại trang hiện tại -->
                                    <input type="hidden" name="redirect" th:value="${backUrl}"/>
                                    <textarea name="content" class="form-control" rows="3" maxlength="200"
                                              placeholder="Nhập phản hồi cho feedback này…"></textarea>
                                    <div class="text-end mt-2">
                                        <button class="btn btn-sm btn-primary">
                                            <i class="bi bi-send"></i> Gửi phản hồi
                                        </button>
                                    </div>
                                </form>
                            </div>

                        </div>
                    </td>
                </tr>

                <tr th:if="${#lists.isEmpty(feedbacks)}">
                    <td colspan="5" class="text-center text-muted py-4">
                        Chưa có feedback nào.
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script th:src="@{/webjars/bootstrap/5.3.2/js/bootstrap.bundle.min.js}"></script>
<script>
    function looksSpacedOutText(s){
        s = (s || "").trim().replace(/\s+/g," ");
        if (s.length < 9) return false;
        const parts = s.split(" ");
        if (parts.length < 5) return false;
        return parts.every(p => /^[\p{L}\p{N}]$/u.test(p));
    }

    // Bắt tất cả form gửi reply của seller
    document.querySelectorAll('form[action*="/seller/feedback/"][action$="/reply"]').forEach(f=>{
        f.addEventListener('submit', (e)=>{
            const ta = f.querySelector('textarea[name="content"],input[name="content"]');
            if (!ta) return;
            const v = (ta.value || "").trim();
            if (looksSpacedOutText(v)) {
                e.preventDefault();
                ta.classList.add('is-invalid');
                if (!ta.nextElementSibling || !ta.nextElementSibling.classList.contains('invalid-feedback')) {
                    const fb = document.createElement('div');
                    fb.className = 'invalid-feedback';
                    fb.textContent = 'Vui lòng không chèn khoảng trắng giữa từng ký tự.';
                    ta.after(fb);
                }
                ta.focus();
                setTimeout(()=>ta.classList.remove('is-invalid'), 2000);
            }
        });
    });
</script>
</body>
</html>
