<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Add New Tool</title>
    <link rel="stylesheet" th:href="@{/css/tool.css}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
</head>
<body>

<div class="page-header" style="max-width:700px; margin:1rem auto;">
    <h1 class="page-title">Add New Tool</h1>
    <a href="/seller/tools" class="back-btn">‚Üê Back</a>
</div>

<section class="container">

    <!-- ‚úÖ Flash messages -->
    <div th:if="${success}" class="alert alert-success" th:text="${success}"></div>
    <div th:if="${error}" class="alert alert-error" th:text="${error}"></div>
    <div th:if="${info}" class="alert alert-info" th:text="${info}"></div>

    <form th:action="@{/seller/tools/add}" th:object="${tool}" method="post" enctype="multipart/form-data">


        <!-- üîπ Tool name -->
        <div class="form-group">
            <label class="form-label">Tool Name</label>
            <input type="text" th:field="*{toolName}" placeholder="Enter tool name" class="form-input" required
                   pattern="^[A-Za-z0-9]+(?: [A-Za-z0-9]+)*$"
                   title="Only letters/numbers, single space allowed">
            <small th:if="${#fields.hasErrors('toolName')}"
                   th:errors="*{toolName}" style="color:#dc2626;"></small>
        </div>

        <!-- üîπ Image upload -->
        <div class="form-group">
            <label class="form-label">Upload Image</label>
            <input type="file" name="imageFile" class="form-control" accept="image/png,image/jpeg" onchange="previewImg(event)">
            <img id="imgPreview" class="preview-img" alt="Image Preview" style="display:none;">
        </div>

        <!-- üîπ Tool file -->
        <div class="form-group">
            <label class="form-label">Upload Tool File (.exe, .zip, .rar)</label>
            <input type="file" name="toolFile" class="form-control" accept=".exe,.zip,.rar" required>
        </div>

        <!-- üîπ Category -->
        <div class="form-group">
            <label class="form-label">Category</label>
            <select th:field="*{category.categoryId}" class="form-select" required>
                <option value="">-- Select category --</option>
                <option th:each="c : ${categories}"
                        th:value="${c.categoryId}"
                        th:text="${c.categoryName}"
                        th:selected="${c.categoryId == selectedCategory}">
                </option>
            </select>
        </div>

        <!-- üîπ Description -->
        <div class="form-group">
            <label class="form-label">Description</label>
            <textarea th:field="*{description}" class="form-textarea"
                      placeholder="Enter description" required></textarea>
        </div>

        <!-- üîπ Login method -->
        <div class="form-group">
            <label class="form-label">Login Method</label>
            <select name="loginMethod" class="form-select" required>
                <option value="">-- Select method --</option>
                <option value="USER_PASSWORD"
                        th:selected="${tool.loginMethod?.name() == 'USER_PASSWORD'}">
                    User & Password
                </option>
                <option value="TOKEN"
                        th:selected="${tool.loginMethod?.name() == 'TOKEN'}">
                    Token (Key-based)
                </option>
            </select>
        </div>

        <!-- üîπ Quantity -->
        <div class="form-group">
            <label class="form-label">Quantity</label>
            <input type="number" th:field="*{quantity}" min="1"
                   placeholder="Enter quantity" class="form-input" required>
        </div>

        <!-- üîπ License packages -->
        <div class="form-group">
            <label class="form-label">License Packages</label>
            <div id="licenseContainer">
                <!-- ‚úÖ Hi·ªÉn th·ªã license t·ª´ session n·∫øu c√≥ -->
                <div th:each="lic : ${licenses}"
                     class="license-row"
                     style="display:flex;gap:10px;align-items:center;margin-bottom:8px;">
                    <input type="number" name="licenseDays"
                           th:value="${lic.durationDays}"
                           min="1" placeholder="Days" class="form-input" style="flex:1;" required>
                    <input type="number" name="licensePrices"
                           th:value="${lic.price}"
                           min="0" placeholder="Price (VNƒê)" class="form-input" style="flex:1;" required>
                    <button type="button" class="remove-btn" onclick="removeLicenseRow(this)"
                            style="background:none;border:none;color:#dc2626;font-size:18px;cursor:pointer;">
                        <i class="bi bi-x-lg"></i>
                    </button>
                </div>

                <!-- ‚úÖ N·∫øu ch∆∞a c√≥ license n√†o -->
                <div th:if="${#lists.isEmpty(licenses)}"
                     class="license-row"
                     style="display:flex;gap:10px;align-items:center;margin-bottom:8px;">
                    <input type="number" name="licenseDays" min="1" placeholder="Days" class="form-input" style="flex:1;" required>
                    <input type="number" name="licensePrices" min="0" placeholder="Price (VNƒê)" class="form-input" style="flex:1;" required>
                    <button type="button" class="remove-btn" onclick="removeLicenseRow(this)"
                            style="background:none;border:none;color:#dc2626;font-size:18px;cursor:pointer;">
                        <i class="bi bi-x-lg"></i>
                    </button>
                </div>
            </div>

            <button type="button" class="add-btn" onclick="addLicenseRow()">+ Add another</button>
        </div>

        <div class="form-actions">
            <button type="submit" class="submit-btn">Save Tool</button>
            <button type="button" class="cancel-btn" onclick="cancelTool()">Cancel</button>
        </div>
    </form>
</section>

<script>
    document.querySelector('input[name="imageFile"]').addEventListener('change', e => {
        const file = e.target.files[0];
        const preview = document.getElementById('previewImage');
        if (file) {
            const reader = new FileReader();
            reader.onload = ev => {
                preview.src = ev.target.result;
                preview.style.display = 'block';
            };
            reader.readAsDataURL(file);
        }
    });

    // ‚úÖ Add new license row
    function addLicenseRow() {
        const container = document.getElementById('licenseContainer');
        const row = document.createElement('div');
        row.className = 'license-row';
        row.style.cssText = 'display:flex;gap:10px;align-items:center;margin-bottom:8px;';
        row.innerHTML = `
          <input type="number" name="licenseDays" min="1" placeholder="Days" class="form-input" style="flex:1;" required>
          <input type="number" name="licensePrices" min="0" placeholder="Price (VNƒê)" class="form-input" style="flex:1;" required>
          <button type="button" class="remove-btn" onclick="removeLicenseRow(this)"
                  style="background:none;border:none;color:#dc2626;font-size:18px;cursor:pointer;">
              <i class="bi bi-x-lg"></i>
          </button>
        `;
        container.appendChild(row);
    }

    // ‚úÖ Remove license row
    function removeLicenseRow(btn) {
        const container = document.getElementById('licenseContainer');
        if (container.children.length > 1) {
            btn.closest('.license-row').remove();
        } else {
            alert("At least one license package is required!");
        }
    }
    function cancelTool() {
        if (confirm("Are you sure you want to cancel tool creation?")) {
            fetch('/seller/token-manage/back', {
                method: 'POST'
            }).then(() => {
                window.location.href = '/seller/tools/add';
            });
        }
    }
    function previewImg(e) {
        const file = e.target.files[0];
        const img = document.getElementById("imgPreview");
        if (!file || !img) return;
        const reader = new FileReader();
        reader.onload = ev => {
            img.src = ev.target.result;
            img.style.display = "block";
        };
        reader.readAsDataURL(file);
    }
</script>
</body>
</html>
