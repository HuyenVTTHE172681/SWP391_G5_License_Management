<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Sales Report</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body {
            background-color: #f9fafb;
            font-family: 'Segoe UI', sans-serif;
        }
        .page-title {
            color: #16a34a;
            font-weight: 700;
            text-align: center;
            margin-bottom: 1rem;
        }
        .filter-box {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 2rem;
        }
        .chart-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        .chart-card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            padding: 1.5rem;
            transition: transform 0.3s ease;
        }
        .btn-outline-success {
            border: 2px solid #16a34a;
            color: #16a34a;
            font-weight: 600;
            transition: all 0.2s ease;
        }
        .btn-outline-success:hover {
            background-color: #16a34a;
            color: white;
            transform: translateY(-2px);
        }
        .chart-card:hover { transform: translateY(-4px); }
        .chart-title { font-weight: 600; margin-bottom: 1rem; }
        canvas { width: 100% !important; height: 360px !important; }
    </style>
</head>

<body>
<div class="container mt-5">
    <h2 class="page-title">
        üìä Sales Report
        <span th:if="${tool != null}" th:text="' - ' + ${tool.toolName}"></span>
    </h2>

    <p class="text-muted text-center mb-4">
        Filter sales data by period or view overall performance.
    </p>

    <!-- üîπ Filter -->
    <div class="filter-box">
        <label class="fw-semibold">Filter by:</label>
        <select id="filterSelect" class="form-select" style="width:200px">
            <option value="day">Day</option>
            <option value="week">Week</option>
            <option value="month" selected>Month</option>
        </select>
        <button class="btn btn-success px-4" onclick="loadChart()">Go</button>
    </div>

    <!-- üîπ Top Row: Line + Pie -->
    <div class="chart-grid">
        <div class="chart-card">
            <h5 class="chart-title">üìà Revenue Over Time</h5>
            <canvas id="lineChart"></canvas>
        </div>
        <div class="chart-card">
            <h5 class="chart-title text-center">ü•ß Revenue Distribution by Tool</h5>
            <canvas id="pieChart"></canvas>
        </div>
    </div>

    <!-- üîπ Bottom Row: Bar -->
    <div class="chart-card mb-5">
        <h5 class="chart-title">üìä Monthly Revenue Comparison</h5>
        <canvas id="barChart"></canvas>
    </div>
</div>

<script>
    const toolId = /*[[${tool != null} ? ${tool.toolId} : '']]*/ '';
    let lineChart, barChart, pieChart;

    async function loadChart() {
        const filter = document.getElementById("filterSelect").value;
        const url = `/seller/tools/sales-report/data?filter=${filter}${toolId ? `&toolId=${toolId}` : ''}`;
        const res = await fetch(url);
        const json = await res.json();

        let labels = json.labels || [];
        let data = json.data || [];

        // üü¢ N·∫øu filter = week th√¨ s·∫Øp x·∫øp theo tu·∫ßn (W)
        if (filter === 'week') {
            const combined = labels.map((label, index) => ({
                label,
                value: data[index]
            }));

            combined.sort((a, b) => {
                const [yearA, weekA] = a.label.split('-W').map(Number);
                const [yearB, weekB] = b.label.split('-W').map(Number);
                if (yearA === yearB) return weekA - weekB;
                return yearA - yearB;
            });

            labels = combined.map(i => i.label);
            data = combined.map(i => i.value);
        }

        // üü† N·∫øu ch∆∞a c√≥ d·ªØ li·ªáu th√¨ t·∫°o dummy
        if (!labels.length) {
            labels = ["No Data"];
            data = [0];
        }

        // X√≥a chart c≈© n·∫øu c√≥
        if (lineChart) lineChart.destroy();
        if (barChart) barChart.destroy();
        if (pieChart) pieChart.destroy();

        renderLineChart(labels, data, filter);
        renderBarChart(labels, data, filter);
        renderPieChart(labels, data);
    }

    // ================= LINE CHART =================
    function renderLineChart(labels, data, filter) {
        const ctx = document.getElementById('lineChart').getContext('2d');
        lineChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: `Doanh thu (${filter})`,
                    data: data,
                    borderColor: '#22c55e',
                    backgroundColor: 'rgba(34,197,94,0.15)',
                    fill: true,
                    tension: 0.3,
                    pointRadius: 4,
                    pointHoverRadius: 6,
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: { display: true, text: "Doanh thu (VND)" },
                        ticks: {
                            callback: value => value.toLocaleString('vi-VN') + '‚Ç´'
                        }
                    }
                },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: ctx => `${ctx.parsed.y.toLocaleString('vi-VN')}‚Ç´`
                        }
                    }
                }
            }
        });
    }

    // ================= BAR CHART =================
    function renderBarChart(labels, data, filter) {
        const ctx = document.getElementById('barChart').getContext('2d');
        barChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: `Doanh thu (${filter})`,
                    data: data,
                    backgroundColor: [
                        '#22c55e', '#3b82f6', '#f97316', '#ef4444',
                        '#a855f7', '#06b6d4', '#84cc16', '#ec4899', '#f59e0b', '#8b5cf6'
                    ],
                    borderRadius: 6
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: { display: true, text: "Doanh thu (VND)" },
                        ticks: {
                            callback: value => value.toLocaleString('vi-VN') + '‚Ç´'
                        }
                    }
                },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: ctx => `${ctx.parsed.y.toLocaleString('vi-VN')}‚Ç´`
                        }
                    }
                }
            }
        });
    }

    // ================= PIE CHART =================
    function renderPieChart(labels, data) {
        const ctx = document.getElementById('pieChart').getContext('2d');
        const total = data.reduce((a, b) => a + b, 0);

        pieChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: [
                        '#22c55e', '#3b82f6', '#f97316', '#ef4444',
                        '#a855f7', '#06b6d4', '#84cc16', '#ec4899', '#f59e0b', '#8b5cf6'
                    ],
                    borderWidth: 2
                }]
            },
            options: {
                cutout: '70%',
                plugins: {
                    legend: { position: 'bottom' },
                    tooltip: {
                        callbacks: {
                            label: ctx => {
                                const pct = ((ctx.parsed / total) * 100).toFixed(1);
                                return `${ctx.label}: ${ctx.parsed.toLocaleString('vi-VN')}‚Ç´ (${pct}%)`;
                            }
                        }
                    }
                }
            },
            plugins: [{
                id: 'centerText',
                afterDraw(chart) {
                    const { width, height, ctx } = chart;
                    ctx.save();
                    ctx.font = 'bold 16px Segoe UI';
                    ctx.textAlign = 'center';
                    ctx.fillStyle = '#111';
                    ctx.fillText('T·ªïng doanh thu', width / 2, height / 2 - 10);
                    ctx.font = '600 15px Segoe UI';
                    ctx.fillStyle = '#22c55e';
                    ctx.fillText(total.toLocaleString('vi-VN') + '‚Ç´', width / 2, height / 2 + 15);
                }
            }]
        });
    }

    // Load chart khi m·ªü trang
    loadChart();
</script>

<div class="text-center mt-4 mb-5">
    <a th:href="@{/seller/tools}" class="btn btn-outline-success px-4">
        ‚Üê Back to Homepage
    </a>
</div>
</body>
</html>
