<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Tool Detail</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link th:href="@{/css/home.css}" rel="stylesheet">

    <!-- CSRF META -->
    <meta name="_csrf" th:if="${_csrf != null}" th:content="${_csrf.token}">
    <meta name="_csrf_parameter" th:if="${_csrf != null}" th:content="${_csrf.parameterName}">
</head>

<body>

<div th:replace="common/header :: header"></div>

<main class="container my-5">

    <!-- FLASH ERROR -->
    <div th:if="${error}" class="alert alert-danger alert-dismissible fade show">
        <span th:text="${error}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <!-- FLASH OK -->
    <div th:if="${ok}" class="alert alert-success alert-dismissible fade show">
        <span th:text="${ok}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <div class="row g-4">

        <!-- IMAGE -->
        <div class="col-md-5">
            <img th:if="${tool.image != null}" th:src="@{'/' + ${tool.image}}" class="img-fluid rounded">
            <img th:unless="${tool.image != null}" src="/placeholder.svg?height=250&width=350" class="img-fluid rounded">
        </div>

        <!-- INFO -->
        <div class="col-md-7">

            <div class="mb-2">
                <span class="badge bg-secondary" th:text="${tool.category.categoryName}"></span>
                <span class="product-name-detail" th:text="${tool.toolName}"></span>
            </div>

            <!-- RATING -->
            <div class="d-flex align-items-center mb-3">
                <div class="me-3 stars">
                    <span th:each="i : ${#numbers.sequence(1,5)}">
                        <i th:class="${i <= avgRating ? 'fas fa-star text-warning' : 'far fa-star text-secondary'}"></i>
                    </span>
                </div>
                <div><small th:text="${totalReviews} + ' đánh giá'"></small></div>
            </div>

            <!-- SELLER & STOCK -->
            <div class="mb-2 sellerName">
                <p>Người bán: <b th:text="${tool.seller.fullName}"></b></p>
                <p>Kho: <b th:text="${tool.quantity}"></b></p>

                <!-- PRICE SAFE -->
                <span id="license-price"
                      th:if="${!#lists.isEmpty(tool.licenses)}"
                      th:data-price="${tool.licenses[0].price}"
                      th:text="${tool.licenses[0].price != null ? tool.licenses[0].price + ' VND' : 'Miễn phí'}"></span>

                <span th:if="${#lists.isEmpty(tool.licenses)}">Chưa có license</span>
            </div>

            <!-- LICENSE LIST -->
            <div class="mb-2 sellerName">
                <p>License</p>

                <div th:if="${#lists.isEmpty(tool.licenses)}" class="text-muted">Chưa có license</div>

                <div class="license-list" th:if="${!#lists.isEmpty(tool.licenses)}">
                    <div th:each="lic, iStat : ${tool.licenses}"
                         th:id="'lic-'+${lic.licenseId}"
                         th:class="'license-item' + (iStat.index == 0 ? ' active' : '')"
                         th:data-price="${lic.price}"
                         th:data-licenseid="${lic.licenseId}"
                         th:text="${lic.name}"
                         onclick="selectLicense(this)">
                    </div>
                </div>
            </div>

            <!-- BUY BUTTON -->
            <div class="actions mt-4 d-flex align-items-center gap-3">
                    <!--Payment VNPay-->
                <form id="buyForm" th:action="@{/payment/create}" method="get">
                <!--Payment PayPal-->
<!--                <form id="buyForm" th:action="@{/paypal-payment/create}" method="get">-->
                    <input type="hidden" name="toolId" th:value="${tool.toolId}">
                    <input type="hidden" id="selectedLicense" name="licenseId"
                           th:value="${!#lists.isEmpty(tool.licenses) ? tool.licenses[0].licenseId : 0}">

                    <button type="button"
                            class="btn btn-success px-4"
                            th:disabled="${tool.quantity == 0}"
                            th:text="${tool.quantity == 0 ? 'Hết hàng' : 'Mua hàng'}"
                            onclick="buyNow()"></button>
                </form>
            </div>
        </div>
    </div>

    <!-- TABS -->
    <div class="mt-5">
        <ul class="nav nav-tabs">
            <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#desc">Mô tả</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#review">Đánh giá</button></li>
        </ul>

        <div class="tab-content p-3 border border-top-0">

            <!-- DESCRIPTION -->
            <div class="tab-pane fade show active" id="desc">
                <div th:text="${tool.description}"></div>
            </div>

            <!-- REVIEWS -->
            <div class="tab-pane fade" id="review">

                <div th:if="${feedbackPage.content.size() == 0}" class="text-muted">Chưa có review</div>

                <!-- FEEDBACK ITEM -->
                <div th:each="fb : ${feedbackPage.content}" class="review-item py-3 border-bottom">

                    <div class="d-flex">
                        <div class="me-3">
                            <div style="width:48px;height:48px;border-radius:50%;background:#ddd;"></div>
                        </div>

                        <div class="flex-grow-1">

                            <!-- HEADER -->
                            <div class="d-flex justify-content-between">
                                <div>
                                    <strong th:text="${fb.account.fullName}"></strong>
                                    <small class="text-muted ms-2"
                                           th:if="${fb.createdAt != null}"
                                           th:text="${#temporals.format(fb.createdAt, 'dd/MM/yyyy HH:mm')}"></small>
                                </div>

                                <!-- ACTION BUTTONS -->
                                <div th:if="${account != null}" class="d-flex gap-1">
                                    <!-- Edit -->
                                    <a th:if="${fb.account.accountId == account.accountId}"
                                       class="btn btn-sm btn-outline-primary"
                                       th:href="@{/feedback/{fid}/edit(fid=${fb.feedbackId})}">
                                        <i class="fa-regular fa-pen-to-square"></i> Sửa
                                    </a>

                                    <!-- Report -->
                                    <button class="btn btn-sm btn-outline-warning"
                                            th:attr="data-fid=${fb.feedbackId}"
                                            onclick="reportFeedback(this)">
                                        <i class="fa-regular fa-flag"></i> Báo cáo
                                    </button>
                                </div>
                            </div>

                            <!-- STARS -->
                            <div class="stars my-1">
                                <span th:each="i : ${#numbers.sequence(1,5)}">
                                    <i th:class="${i <= fb.rating ? 'fas fa-star text-warning' : 'far fa-star text-secondary'}"></i>
                                </span>
                            </div>

                            <!-- COMMENT -->
                            <div th:text="${fb.comment}"></div>

                            <!-- REPLIES BLOCK (ĐÃ FIX ĐÓNG THẺ) -->
                            <div class="mt-3 ps-3 border-start"
                                 th:with="reps=${repliesMap != null and repliesMap.containsKey(fb.feedbackId) ? repliesMap[fb.feedbackId] : null}"
                                 th:id="'replies-box-' + ${fb.feedbackId}">

                                <div th:if="${reps != null}">
                                    <div th:each="rep : ${reps}" class="mb-2">
                                        <div class="small text-muted">
                                            <i class="fa-solid fa-reply"></i>
                                            <strong th:text="${rep.seller.fullName}"></strong>
                                            <span th:if="${rep.createdAt != null}"
                                                  th:text="' • ' + ${#temporals.format(rep.createdAt,'dd/MM/yyyy HH:mm')}"></span>
                                        </div>
                                        <div th:text="${rep.content}"></div>
                                    </div>
                                </div>

                                <!-- SELLER REPLY FORM -->
                                <form th:if="${account != null and tool.seller.accountId == account.accountId}"
                                      th:action="@{/seller/feedback/{fid}/reply(fid=${fb.feedbackId})}"
                                      class="d-flex gap-2 mt-2 reply-form"
                                      th:attr="data-fid=${fb.feedbackId}"
                                      method="post">

                                    <input th:if="${_csrf != null}" type="hidden"
                                           th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

                                    <input type="text" name="content" maxlength="200"
                                           class="form-control form-control-sm"
                                           placeholder="Trả lời người mua…" required>

                                    <button class="btn btn-sm btn-primary" type="submit">Gửi</button>
                                </form>

                            </div> <!-- KẾT THÚC BLOCK REPLY -->

                        </div>
                    </div>
                </div>

                <!-- PAGINATION -->
                <nav th:if="${feedbackPage.totalPages > 1}" class="mt-3">
                    <ul class="pagination">
                        <li class="page-item" th:classappend="${feedbackPage.first} ? 'disabled'">
                            <a class="page-link"
                               th:href="@{/tools/{id}(id=${tool.toolId},reviewPage=${feedbackPage.number - 1})#review}">
                                Previous
                            </a>
                        </li>

                        <li th:each="i : ${#numbers.sequence(0, feedbackPage.totalPages - 1)}"
                            class="page-item"
                            th:classappend="${i == feedbackPage.number} ? 'active'">
                            <a class="page-link"
                               th:href="@{/tools/{id}(id=${tool.toolId},reviewPage=${i})#review}"
                               th:text="${i + 1}">
                            </a>
                        </li>

                        <li class="page-item" th:classappend="${feedbackPage.last} ? 'disabled'">
                            <a class="page-link"
                               th:href="@{/tools/{id}(id=${tool.toolId},reviewPage=${feedbackPage.number + 1})#review}">
                                Next
                            </a>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</main>

<div th:replace="common/footer :: footer"></div>

<!-- JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script th:inline="javascript">
    /*<![CDATA[*/

    var isLoggedIn = /*[[${account != null}]]*/ false;

    function formatPrice(price) {
        return new Intl.NumberFormat('vi-VN').format(price) + ' VND';
    }

    function selectLicense(el) {
        document.querySelectorAll('.license-item').forEach(e => e.classList.remove('active'));
        el.classList.add('active');
        const price = el.dataset.price;
        const priceEl = document.getElementById('license-price');
        if (priceEl) priceEl.textContent = (price && price !== '0') ? formatPrice(price) : 'Miễn phí';
        document.getElementById('selectedLicense').value = el.dataset.licenseid;
    }

    function buyNow() {
        const qty = /*[[${tool.quantity}]]*/ 0;
        if (qty <= 0) return alert("Hết hàng!");
        if (!isLoggedIn) {
            new bootstrap.Modal(document.getElementById('loginModal')).show();
            return;
        }
        document.getElementById('buyForm').submit();
    }

    /*]]>*/
</script>

</body>
</html>
